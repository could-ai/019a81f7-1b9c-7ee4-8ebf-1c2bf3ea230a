import 'package:flutter/material.dart';\nimport '../models/hotel.dart';\nimport '../models/booking.dart';\nimport '../services/hotel_service.dart';\n\nclass BookingScreen extends StatefulWidget {\n  const BookingScreen({super.key});\n\n  @override\n  State<BookingScreen> createState() => _BookingScreenState();\n}\n\nclass _BookingScreenState extends State<BookingScreen> {\n  final HotelService _hotelService = HotelService();\n  DateTime? _checkInDate;\n  DateTime? _checkOutDate;\n  int _numberOfGuests = 1;\n  int _numberOfRooms = 1;\n  bool _isLoading = false;\n\n  Future<void> _selectCheckInDate(BuildContext context) async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime.now().add(const Duration(days: 365)),\n    );\n    if (picked != null) {\n      setState(() {\n        _checkInDate = picked;\n        // Reset checkout if it's before new checkin\n        if (_checkOutDate != null && _checkOutDate!.isBefore(picked)) {\n          _checkOutDate = null;\n        }\n      });\n    }\n  }\n\n  Future<void> _selectCheckOutDate(BuildContext context) async {\n    if (_checkInDate == null) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Please select check-in date first')),\n      );\n      return;\n    }\n\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _checkInDate!.add(const Duration(days: 1)),\n      firstDate: _checkInDate!.add(const Duration(days: 1)),\n      lastDate: _checkInDate!.add(const Duration(days: 30)),\n    );\n    if (picked != null) {\n      setState(() => _checkOutDate = picked);\n    }\n  }\n\n  double _calculateTotalPrice(Hotel hotel) {\n    if (_checkInDate == null || _checkOutDate == null) return 0;\n    final nights = _checkOutDate!.difference(_checkInDate!).inDays;\n    return hotel.pricePerNight * nights * _numberOfRooms;\n  }\n\n  int _getNumberOfNights() {\n    if (_checkInDate == null || _checkOutDate == null) return 0;\n    return _checkOutDate!.difference(_checkInDate!).inDays;\n  }\n\n  Future<void> _confirmBooking(Hotel hotel) async {\n    if (_checkInDate == null || _checkOutDate == null) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Please select check-in and check-out dates')),\n      );\n      return;\n    }\n\n    setState(() => _isLoading = true);\n\n    try {\n      final booking = await _hotelService.createBooking(\n        hotelId: hotel.id,\n        checkInDate: _checkInDate!,\n        checkOutDate: _checkOutDate!,\n        numberOfGuests: _numberOfGuests,\n        numberOfRooms: _numberOfRooms,\n      );\n\n      setState(() => _isLoading = false);\n\n      if (mounted) {\n        // Show success dialog\n        showDialog(\n          context: context,\n          barrierDismissible: false,\n          builder: (context) => AlertDialog(\n            title: const Row(\n              children: [\n                Icon(Icons.check_circle, color: Colors.green, size: 32),\n                SizedBox(width: 12),\n                Text('Booking Confirmed!'),\n              ],\n            ),\n            content: Column(\n              mainAxisSize: MainAxisSize.min,\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text('Booking ID: ${booking.id}'),\n                const SizedBox(height: 8),\n                Text('Hotel: ${booking.hotelName}'),\n                const SizedBox(height: 8),\n                Text(\n                  'Total: \$${booking.totalPrice.toStringAsFixed(2)}',\n                  style: const TextStyle(fontWeight: FontWeight.bold),\n                ),\n              ],\n            ),\n            actions: [\n              TextButton(\n                onPressed: () {\n                  Navigator.of(context).pop(); // Close dialog\n                  Navigator.of(context).pop(); // Go back to details\n                  Navigator.of(context).pop(); // Go back to home\n                },\n                child: const Text('Back to Home'),\n              ),\n              ElevatedButton(\n                onPressed: () {\n                  Navigator.of(context).pop(); // Close dialog\n                  Navigator.pushReplacementNamed(context, '/my-bookings');\n                },\n                child: const Text('View Bookings'),\n              ),\n            ],\n          ),\n        );\n      }\n    } catch (e) {\n      setState(() => _isLoading = false);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Booking failed: $e')),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final Hotel hotel = ModalRoute.of(context)!.settings.arguments as Hotel;\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Complete Booking'),\n        backgroundColor: Theme.of(context).colorScheme.primary,\n        foregroundColor: Colors.white,\n      ),\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : SingleChildScrollView(\n              padding: const EdgeInsets.all(16),\n              child: Column(\n                crossAxisAlignment: CrossAxisAlignment.start,\n                children: [\n                  // Hotel info card\n                  Card(\n                    child: Padding(\n                      padding: const EdgeInsets.all(16),\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          Text(\n                            hotel.name,\n                            style: const TextStyle(\n                              fontSize: 20,\n                              fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n                          Row(\n                            children: [\n                              const Icon(Icons.location_on, size: 16, color: Colors.red),\n                              const SizedBox(width: 4),\n                              Text(hotel.location),\n                            ],\n                          ),\n                          const SizedBox(height: 8),\n                          Text(\n                            '\$${hotel.pricePerNight.toStringAsFixed(2)} per night',\n                            style: TextStyle(\n                              fontSize: 16,\n                              color: Theme.of(context).colorScheme.primary,\n                              fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                        ],\n                      ),\n                    ),\n                  ),\n                  const SizedBox(height: 24),\n                  // Dates section\n                  const Text(\n                    'Select Dates',\n                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n                  ),\n                  const SizedBox(height: 12),\n                  Row(\n                    children: [\n                      Expanded(\n                        child: InkWell(\n                          onTap: () => _selectCheckInDate(context),\n                          child: Container(\n                            padding: const EdgeInsets.all(16),\n                            decoration: BoxDecoration(\n                              border: Border.all(color: Colors.grey[300]!),\n                              borderRadius: BorderRadius.circular(12),\n                            ),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                const Text('Check-in', style: TextStyle(color: Colors.grey)),\n                                const SizedBox(height: 8),\n                                Text(\n                                  _checkInDate != null\n                                      ? '${_checkInDate!.day}/${_checkInDate!.month}/${_checkInDate!.year}'\n                                      : 'Select date',\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.bold,\n                                  ),\n                                ),\n                              ],\n                            ),\n                          ),\n                        ),\n                      ),\n                      const SizedBox(width: 12),\n                      Expanded(\n                        child: InkWell(\n                          onTap: () => _selectCheckOutDate(context),\n                          child: Container(\n                            padding: const EdgeInsets.all(16),\n                            decoration: BoxDecoration(\n                              border: Border.all(color: Colors.grey[300]!),\n                              borderRadius: BorderRadius.circular(12),\n                            ),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                const Text('Check-out', style: TextStyle(color: Colors.grey)),\n                                const SizedBox(height: 8),\n                                Text(\n                                  _checkOutDate != null\n                                      ? '${_checkOutDate!.day}/${_checkOutDate!.month}/${_checkOutDate!.year}'\n                                      : 'Select date',\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.bold,\n                                  ),\n                                ),\n                              ],\n                            ),\n                          ),\n                        ),\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                  // Guests and rooms\n                  const Text(\n                    'Guests & Rooms',\n                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n                  ),\n                  const SizedBox(height: 12),\n                  Row(\n                    children: [\n                      Expanded(\n                        child: _buildCounter(\n                          'Guests',\n                          _numberOfGuests,\n                          (value) => setState(() => _numberOfGuests = value),\n                        ),\n                      ),\n                      const SizedBox(width: 12),\n                      Expanded(\n                        child: _buildCounter(\n                          'Rooms',\n                          _numberOfRooms,\n                          (value) => setState(() => _numberOfRooms = value),\n                        ),\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                  // Price summary\n                  if (_checkInDate != null && _checkOutDate != null) ..[\n                    const Divider(),\n                    const SizedBox(height: 16),\n                    const Text(\n                      'Price Summary',\n                      style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n                    ),\n                    const SizedBox(height: 12),\n                    Row(\n                      mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                      children: [\n                        const Text('Number of nights:'),\n                        Text(\n                          '${_getNumberOfNights()} nights',\n                          style: const TextStyle(fontWeight: FontWeight.bold),\n                        ),\n                      ],\n                    ),\n                    const SizedBox(height: 8),\n                    Row(\n                      mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                      children: [\n                        const Text('Rooms:'),\n                        Text(\n                          '$_numberOfRooms',\n                          style: const TextStyle(fontWeight: FontWeight.bold),\n                        ),\n                      ],\n                    ),\n                    const SizedBox(height: 16),\n                    Container(\n                      padding: const EdgeInsets.all(16),\n                      decoration: BoxDecoration(\n                        color: Theme.of(context).colorScheme.primaryContainer,\n                        borderRadius: BorderRadius.circular(12),\n                      ),\n                      child: Row(\n                        mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                        children: [\n                          const Text(\n                            'Total Price:',\n                            style: TextStyle(\n                              fontSize: 18,\n                              fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                          Text(\n                            '\$${_calculateTotalPrice(hotel).toStringAsFixed(2)}',\n                            style: TextStyle(\n                              fontSize: 24,\n                              fontWeight: FontWeight.bold,\n                              color: Theme.of(context).colorScheme.primary,\n                            ),\n                          ),\n                        ],\n                      ),\n                    ),\n                  ],\n                  const SizedBox(height: 100),\n                ],\n              ),\n            ),\n      bottomSheet: Container(\n        padding: const EdgeInsets.all(16),\n        decoration: BoxDecoration(\n          color: Colors.white,\n          boxShadow: [\n            BoxShadow(\n              color: Colors.black.withOpacity(0.1),\n              blurRadius: 10,\n              offset: const Offset(0, -2),\n            ),\n          ],\n        ),\n        child: SafeArea(\n          child: SizedBox(\n            width: double.infinity,\n            child: ElevatedButton(\n              onPressed: _isLoading ? null : () => _confirmBooking(hotel),\n              style: ElevatedButton.styleFrom(\n                backgroundColor: Theme.of(context).colorScheme.primary,\n                foregroundColor: Colors.white,\n                padding: const EdgeInsets.symmetric(vertical: 16),\n                shape: RoundedRectangleBorder(\n                  borderRadius: BorderRadius.circular(12),\n                ),\n              ),\n              child: const Text(\n                'Confirm Booking',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildCounter(String label, int value, Function(int) onChanged) {\n    return Container(\n      padding: const EdgeInsets.all(16),\n      decoration: BoxDecoration(\n        border: Border.all(color: Colors.grey[300]!),\n        borderRadius: BorderRadius.circular(12),\n      ),\n      child: Column(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          Text(label, style: const TextStyle(color: Colors.grey)),\n          const SizedBox(height: 8),\n          Row(\n            mainAxisAlignment: MainAxisAlignment.spaceBetween,\n            children: [\n              IconButton(\n                icon: const Icon(Icons.remove_circle_outline),\n                onPressed: value > 1 ? () => onChanged(value - 1) : null,\n              ),\n              Text(\n                value.toString(),\n                style: const TextStyle(\n                  fontSize: 18,\n                  fontWeight: FontWeight.bold,\n                ),\n              ),\n              IconButton(\n                icon: const Icon(Icons.add_circle_outline),\n                onPressed: () => onChanged(value + 1),\n              ),\n            ],\n          ),\n        ],\n      ),\n    );\n  }\n}\n